<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Монополия улитка + FINISH оптимизированный</title>
<style>
  body { margin: 0; background: #000; overflow: hidden; font-family: Arial; }
  canvas { display: block; }
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){ 
  canvas.width = window.innerWidth; 
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

// ---------- ИГРОКИ ----------
const PLAYERS = 4;
let playerPos = [0,0,0,0];
let currentPlayer = 0;
let skipTurn = [false,false,false,false];
const colors = ["green","red","blue","gold"];
const PLAYER_RADIUS_RATIO = 0.15; // радиус игрока относительно клетки

// ---------- ПОЛЕ ----------
const TOTAL_CELLS = 12; 
let CELL_SIZE; 
const BOARD_MARGIN = 80;
let cells = [];
let finishCell = {}; 

// ---------- СЛОТЫ ----------
const slotValues=["+1 ход","+1 ход","+1 ход","+2 хода","+2 хода","-1 ход","-2 хода","Пропуск"];
let currentSlot=Array(PLAYERS).fill("SPIN");

// ---------- КНОПКА ----------
const spinBtn={w:260,h:70};

// ---------- ВСПОМОГАТЕЛЬНО ----------
function drawRect(x,y,w,h,r=0){
  ctx.beginPath();
  if(r>0 && ctx.roundRect) ctx.roundRect(x,y,w,h,r);
  else ctx.rect(x,y,w,h);
  ctx.fill();
  ctx.stroke();
}

// ---------- Вычисляем клетки по спирали улитка ----------
function generateSpiralCells(){
  const boardSide = Math.min(canvas.width - 2*BOARD_MARGIN, canvas.height - 2*BOARD_MARGIN);
  CELL_SIZE = boardSide / 4; 
  const startX = BOARD_MARGIN;
  const startY = BOARD_MARGIN;
  let x=startX, y=startY;
  let dx=CELL_SIZE, dy=0;
  let minX=startX, minY=startY, maxX=startX + 3*CELL_SIZE, maxY=startY + 3*CELL_SIZE;

  const spiral = [];
  for(let i=0;i<TOTAL_CELLS;i++){
    spiral.push([x,y]);
    // движение по спирали
    if(dx>0 && x+dx>maxX){ dx=0; dy=CELL_SIZE; maxX-=CELL_SIZE;}
    else if(dy>0 && y+dy>maxY){ dx=-CELL_SIZE; dy=0; maxY-=CELL_SIZE;}
    else if(dx<0 && x+dx<minX){ dx=0; dy=-CELL_SIZE; minX+=CELL_SIZE;}
    else if(dy<0 && y+dy<minY){ dx=CELL_SIZE; dy=0; minY+=CELL_SIZE;}
    x += dx;
    y += dy;
  }
  return spiral;
}

// ---------- Отрисовка доски ----------
function drawBoard(){
  if(cells.length===0) cells=generateSpiralCells();
  ctx.font="18px Arial";
  for(let i=0;i<cells.length;i++){
    const c=cells[i];
    ctx.fillStyle="#444"; ctx.strokeStyle="#fff"; drawRect(c[0],c[1],CELL_SIZE,CELL_SIZE);
    ctx.fillStyle="#fff";
    ctx.fillText(i, c[0]+CELL_SIZE-22, c[1]+CELL_SIZE-10);

    for(let p=0;p<PLAYERS;p++){
      if(playerPos[p]===i){
        ctx.fillStyle=colors[p];
        const cx=c[0]+CELL_SIZE/2;
        const cy=c[1]+CELL_SIZE/2;
        const radius = CELL_SIZE * PLAYER_RADIUS_RATIO;
        ctx.beginPath();
        ctx.arc(cx, cy, radius,0,Math.PI*2);
        ctx.fill();

        // ---------- номер игрока ----------
        ctx.fillStyle="#fff";
        ctx.font=`${radius}px Arial`;
        ctx.textAlign="center";
        ctx.textBaseline="middle";
        ctx.fillText(p+1, cx, cy);
      }
    }
  }

  // ---------- FINISH клетка слева от квадрата, не вылезает ----------
  if(Object.keys(finishCell).length===0){
    const first = cells[0];
    let fx = first[0]-CELL_SIZE-20;
    let fy = first[1];
    // проверяем, чтобы не выйти за экран слева
    if(fx < 0) fx = 10;
    finishCell = {x: fx, y: fy, w:CELL_SIZE, h:CELL_SIZE};
  }

  ctx.fillStyle="yellow"; ctx.strokeStyle="#fff";
  drawRect(finishCell.x, finishCell.y, finishCell.w, finishCell.h, 8);
  ctx.fillStyle="#000"; ctx.font="20px Arial"; ctx.fillText("FINISH", finishCell.x+finishCell.w/4, finishCell.y+finishCell.h/2);

  // ---------- Меньший красный флажок с черной ножкой ----------
  const flagX = finishCell.x + finishCell.w - 12;
  const flagY = finishCell.y + 5;
  ctx.fillStyle="black";
  ctx.fillRect(flagX, flagY, 2, finishCell.h-10); // ножка
  ctx.fillStyle="red";
  ctx.beginPath();
  ctx.moveTo(flagX+1, flagY);
  ctx.lineTo(flagX+1, flagY+12);
  ctx.lineTo(flagX+12, flagY+6);
  ctx.closePath();
  ctx.fill();
}

// ---------- Слоты ----------
function drawSlots(){
  for(let i=0;i<PLAYERS;i++){
    const x=canvas.width-360;
    const y=60+i*170;
    ctx.fillStyle="#222"; ctx.strokeStyle="#fff"; drawRect(x,y,300,140,12);

    if(i===currentPlayer){ ctx.strokeStyle="#00f"; ctx.lineWidth=4; drawRect(x,y,300,140,12); ctx.lineWidth=1;}
    ctx.fillStyle="#fff"; ctx.font="24px Arial"; ctx.fillText(`Игрок ${i+1}`,x,y-10);
    ctx.font="28px Arial"; ctx.fillText(currentSlot[i],x+80,y+80);
  }
}

// ---------- Кнопка ----------
function drawButton(){
  spinBtn.x=canvas.width-330;
  spinBtn.y=canvas.height-110;
  ctx.fillStyle="#008cff"; ctx.strokeStyle="#fff"; drawRect(spinBtn.x,spinBtn.y,spinBtn.w,spinBtn.h,14);
  ctx.fillStyle="#fff"; ctx.font="32px Arial"; ctx.fillText("SPIN",spinBtn.x+85,spinBtn.y+45);
}

// ---------- Анимация слота ----------
function animateSlot(){
  const rectX=canvas.width-360;
  const rectY=60+currentPlayer*170;
  const rectW=300; const rectH=140;
  const steps=50; const visibleCount=4;
  let slotQueue=[];
  for(let i=0;i<steps;i++) slotQueue.push(slotValues[Math.floor(Math.random()*slotValues.length)]);
  const finalResult=slotValues[Math.floor(Math.random()*slotValues.length)];
  let frame=0;

  function animate(){
    ctx.fillStyle="#222"; ctx.fillRect(rectX,rectY,rectW,rectH);
    ctx.font="28px Arial"; ctx.fillStyle="#fff";

    for(let i=0;i<visibleCount;i++){
      const val=slotQueue[(frame+i)%slotQueue.length];
      const yPos=rectY + 40 + i*30 - 10*Math.sin(frame/5);
      ctx.fillText(val,rectX+80,yPos);
    }

    frame++;
    if(frame<steps) requestAnimationFrame(animate);
    else{
      currentSlot[currentPlayer]=finalResult;
      if(finalResult==="+1 ход") playerPos[currentPlayer]++;
      if(finalResult==="+2 хода") playerPos[currentPlayer]+=2;
      if(finalResult==="-1 ход") playerPos[currentPlayer]--;
      if(finalResult==="-2 хода") playerPos[currentPlayer]-=2;
      if(finalResult==="Пропуск") skipTurn[currentPlayer]=true;
      if(playerPos[currentPlayer]>=TOTAL_CELLS){
        alert(`Игрок ${currentPlayer+1} победил!`);
        location.reload();
      }
      currentPlayer=(currentPlayer+1)%PLAYERS;
    }
  }
  animate();
}

// ---------- Клик по кнопке ----------
canvas.addEventListener("click",e=>{
  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left;
  const y=e.clientY-r.top;
  if(x>spinBtn.x && x<spinBtn.x+spinBtn.w && y>spinBtn.y && y<spinBtn.y+spinBtn.h){
    if(!skipTurn[currentPlayer]) animateSlot();
    else{skipTurn[currentPlayer]=false; currentPlayer=(currentPlayer+1)%PLAYERS;}
  }
});

// ---------- Главный цикл ----------
function loop(){
  ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height);
  drawBoard(); drawSlots(); drawButton();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
